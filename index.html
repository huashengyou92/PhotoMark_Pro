<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PhotoMark Pro - ç…§ç‰‡æ°´å°å·¥å…·</title>
  <link rel="stylesheet" href="src/styles/main.css">
  <script src="https://unpkg.com/dom-to-image/dist/dom-to-image.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
  <!-- ä½¿ç”¨å¤šä¸ªæ¥æºåŠ è½½HEICåº“ï¼Œæé«˜å¯é æ€§ -->
  <script>
    // æ£€æµ‹HEICåº“æ˜¯å¦å·²åŠ è½½
    function isHeicLibLoaded() {
      return typeof window.heic2any !== 'undefined';
    }
    
    // åŠ è½½HEICåº“çš„å‡½æ•°
    function loadHeicLib() {
      // æ ‡è®°æ­£åœ¨åŠ è½½
      window.heicLibLoading = true;
      
      // å°è¯•ä»ä¸åŒCDNåŠ è½½ï¼ŒæŒ‰é¡ºåºå°è¯•
      const sources = [
        'https://unpkg.com/heic2any@0.0.4/dist/heic2any.min.js',
        'https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/heic2any/0.0.4/heic2any.min.js'
      ];
      
      let currentIndex = 0;
      
      function tryNextSource() {
        if (currentIndex >= sources.length) {
          console.error('æ‰€æœ‰HEICåº“æ¥æºå‡åŠ è½½å¤±è´¥');
          window.heicLibLoading = false;
          return;
        }
        
        const script = document.createElement('script');
        script.src = sources[currentIndex];
        console.log('å°è¯•åŠ è½½HEICåº“:', script.src);
        
        script.onload = function() {
          console.log('HEICåº“åŠ è½½æˆåŠŸ:', script.src);
          window.heicLibLoading = false;
        };
        
        script.onerror = function() {
          console.log('HEICåº“åŠ è½½å¤±è´¥:', script.src);
          currentIndex++;
          tryNextSource();
        };
        
        document.head.appendChild(script);
      }
      
      tryNextSource();
    }
    
    // é¡µé¢åŠ è½½åæ£€æŸ¥HEICåº“
    window.addEventListener('DOMContentLoaded', function() {
      if (!isHeicLibLoaded()) {
        console.log('HEICåº“æœªåŠ è½½ï¼Œå¼€å§‹åŠ è½½...');
        loadHeicLib();
      }
    });
  </script>
  <script src="https://unpkg.com/heic2any@0.3.1/dist/heic2any.min.js"></script>
</head>
<body>
  <header>
    <h1 class="photo-mark-title">PhotoMark Pro</h1>
    <div class="github-corner" id="github-corner"></div>
  </header>
  
  <div class="container">
    
    <div class="preview-box">
      <h2>é¢„è§ˆ</h2>
      <div class="preview" id="preview">
        <img id="preview-picture" class="preview-picture" alt="Preview">
        <div id="loading-indicator" class="loading-indicator"></div>
        <div class="preview-info">
          <div class="preview-info-left">
            <div class="preview-info-model" id="info-model"></div>
            <div class="preview-info-date" id="info-date"></div>
            <div class="preview-info-brand">
              <img id="info-brand-img" alt="Brand">
            </div>
          </div>
          <div class="preview-info-split"></div>
          <div class="preview-info-right">
            <div class="preview-info-device" id="info-device"></div>
            <div class="preview-info-gps" id="info-gps"></div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="button-container">
      <button id="upload-btn" class="action-button">
        <span class="button-icon">ğŸ“·</span>
        <span class="button-text">ä¸Šä¼ ç…§ç‰‡</span>
      </button>
      <button id="random-image" class="action-button random-button">
        <span class="button-icon">ğŸ”„</span>
        <span class="button-text">éšæœºå›¾ç‰‡</span>
      </button>
      <button id="download-btn" class="action-button download-button">
        <span class="button-icon">â†“</span>
        <span class="button-text">å¯¼å‡ºç…§ç‰‡</span>
      </button>
    </div>
    
    <div class="controls">
      <div class="combined-section">
        <div class="section-part settings-area">
          <input type="file" id="image-upload" accept="image/jpeg,image/png,image/jpg,image/heic,image/heif" style="display: none;">
          <h3>æ°´å°è®¾ç½®</h3>
          <form id="exif-form" class="settings-grid">
            <div class="form-group">
              <label for="model">å‹å·</label>
              <input type="text" id="model" name="model" placeholder="ç›¸æœºå‹å·">
            </div>
            
            <div class="form-group">
              <label for="device">è®¾å¤‡</label>
              <input type="text" id="device" name="device" placeholder="è®¾å¤‡åç§°">
            </div>
            
            <div class="form-group">
              <label for="date">æ—¥æœŸ</label>
              <input type="text" id="date" name="date" placeholder="æ‹æ‘„æ—¥æœŸ">
            </div>
            
            <div class="form-group">
              <label for="gps">GPS</label>
              <input type="text" id="gps" name="gps" placeholder="æ‹æ‘„åœ°ç‚¹">
            </div>
            
            <div class="form-group">
              <label for="brand">å“ç‰Œ</label>
              <select id="brand" name="brand"></select>
            </div>
            
            <div class="form-group">
              <label for="font-size">å­—ä½“å¤§å°</label>
              <input type="range" id="font-size" name="font-size" min="10" max="30" value="16">
            </div>
            
            <div class="form-group">
              <label for="font-weight">å­—ä½“ç²—ç»†</label>
              <input type="range" id="font-weight" name="font-weight" min="300" max="900" step="100" value="400">
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    // å¸¸é‡å®šä¹‰
    const BrandsMap = {
      'Apple': 'apple',
      'Canon': 'canon',
      'Dji': 'dji',
      'Fujifilm': 'fujifilm',
      'Huawei': 'huawei',
      'Leica': 'leica',
      'Xiaomi': 'xiaomi',
      'Nikon Corporation': 'nikon corporation',
      'Sony': 'sony',
      'Panasonic': 'panasonic',
      'Ricoh': 'ricoh',
      'Olympus': 'olympus',
      'Arashi Vision': 'insta360',
      'æœªæ”¶å½•': 'unknow'
    };
    
    // æ·»åŠ å„å“ç‰Œçš„é»˜è®¤ä¿¡æ¯é…ç½®
    const BrandDefaultInfo = {
      'Apple': {
        model: 'iPhone 15 Pro Max',
        date: formatDate(new Date()),
        gps: '40Â°45\'28"N 73Â°58\'56"W',
        device: '24mm f/1.8 1/125s ISO64'
      },
      'Canon': {
        model: 'Canon EOS R5',
        date: formatDate(new Date()),
        gps: '37Â°46\'30"N 122Â°25\'07"W',
        device: '70mm f/2.8 1/250s ISO400'
      },
      'Dji': {
        model: 'DJI Mavic 3 Pro',
        date: formatDate(new Date()),
        gps: '34Â°00\'28"N 118Â°28\'42"W',
        device: '24mm f/2.8 1/60s ISO100'
      },
      'Fujifilm': {
        model: 'FUJIFILM X-T5',
        date: formatDate(new Date()),
        gps: '35Â°39\'32"N 139Â°44\'31"E',
        device: '35mm f/1.4 1/500s ISO200'
      },
      'Huawei': {
        model: 'HUAWEI P60 Pro',
        date: formatDate(new Date()),
        gps: '22Â°32\'48"N 114Â°03\'36"E',
        device: '27mm f/1.4 1/100s ISO250'
      },
      'Leica': {
        model: 'Leica M11',
        date: formatDate(new Date()),
        gps: '48Â°51\'24"N 2Â°20\'55"E',
        device: '50mm f/2.0 1/500s ISO100'
      },
      'Xiaomi': {
        model: 'XIAOMI 14 Ultra',
        date: formatDate(new Date()),
        gps: '39Â°54\'26"N 116Â°23\'29"E',
        device: '23mm f/1.6 1/80s ISO320'
      },
      'Nikon Corporation': {
        model: 'Nikon Z9',
        date: formatDate(new Date()),
        gps: '43Â°39\'28"N 79Â°22\'59"W',
        device: '85mm f/1.8 1/200s ISO800'
      },
      'Sony': {
        model: 'SONY Î±7R V',
        date: formatDate(new Date()),
        gps: '51Â°30\'30"N 0Â°07\'32"W',
        device: '24-70mm f/2.8 1/160s ISO500'
      },
      'Panasonic': {
        model: 'Panasonic LUMIX S5 II',
        date: formatDate(new Date()),
        gps: '48Â°08\'24"N 11Â°34\'32"E',
        device: '35mm f/1.8 1/125s ISO400'
      },
      'Ricoh': {
        model: 'RICOH GR IIIx',
        date: formatDate(new Date()),
        gps: '35Â°40\'18"N 139Â°45\'5"E',
        device: '40mm f/2.8 1/60s ISO800'
      },
      'Olympus': {
        model: 'OM SYSTEM OM-1',
        date: formatDate(new Date()),
        gps: '34Â°59\'38"N 135Â°45\'9"E',
        device: '25mm f/1.2 1/250s ISO200'
      },
      'Arashi Vision': {
        model: 'Insta360 ONE X3',
        date: formatDate(new Date()),
        gps: '31Â°13\'52"N 121Â°28\'9"E',
        device: '6.7mm f/1.9 1/30s ISO100'
      },
      'æœªæ”¶å½•': {
        model: 'æœªçŸ¥å‹å·',
        date: formatDate(new Date()),
        gps: '0Â°0\'0"N 0Â°0\'0"E',
        device: 'æœªçŸ¥å‚æ•°'
      }
    };
    
    const BrandsList = Object.keys(BrandsMap);
    
    const DefaultPictureExif = BrandDefaultInfo['Leica']; // ä½¿ç”¨Leicaä½œä¸ºé»˜è®¤
    
    const ExhibitionImages = [
      'public/exhibition/apple.jpg',
      'public/exhibition/canon.jpg',
      'public/exhibition/dji.jpg',
      'public/exhibition/fujifilm.jpg',
      'public/exhibition/huawei.jpg',
      'public/exhibition/leica.jpg',
      'public/exhibition/xiaomi.jpg',
      'public/exhibition/nikon.jpg',
      'public/exhibition/sony.jpg',
      'public/exhibition/panasonic.jpg'
    ];
    
    // DOM å…ƒç´ 
    let previewPicture, infoModel, infoDate, infoBrandImg, infoDevice, infoGps;
    let imageUpload, randomImageBtn, downloadBtn, exifForm, brandSelect;
    let fontSizeInput, fontWeightInput, githubCornerDiv;
    let loadingIndicator, uploadBtn;
    
    // å½“å‰çŠ¶æ€
    let currentFormValues = { ...DefaultPictureExif };
    
    // åˆå§‹åŒ–DOMå…ƒç´ å¼•ç”¨
    function initDomElements() {
      // ä¸Šä¼ å›¾ç‰‡å…ƒç´ 
      imageUpload = document.getElementById('image-upload');
      randomImageBtn = document.getElementById('random-image');
      
      // é¢„è§ˆå…ƒç´ 
      previewPicture = document.getElementById('preview-picture');
      loadingIndicator = document.getElementById('loading-indicator');
      
      // ä¿¡æ¯æ˜¾ç¤ºå…ƒç´ 
      infoModel = document.getElementById('info-model');
      infoDevice = document.getElementById('info-device');
      infoDate = document.getElementById('info-date');
      infoGps = document.getElementById('info-gps');
      infoBrandImg = document.getElementById('info-brand-img');
      
      // è¡¨å•å…ƒç´ 
      exifForm = document.getElementById('exif-form');
      fontSizeInput = document.getElementById('font-size');
      fontWeightInput = document.getElementById('font-weight');
      brandSelect = document.getElementById('brand');
      
      // ä¸‹è½½æŒ‰é’®
      downloadBtn = document.getElementById('download-btn');
      
      // ä¸Šä¼ æŒ‰é’®
      uploadBtn = document.getElementById('upload-btn');
      
      // GitHub è§’è½
      githubCornerDiv = document.getElementById('github-corner');
    }
    
    // åˆå§‹åŒ–å‡½æ•°
    function init() {
      console.log('åˆå§‹åŒ–åº”ç”¨...');
      
      // åˆå§‹åŒ–DOMå…ƒç´ å¼•ç”¨
      initDomElements();
      
      // æ£€æŸ¥DOMå…ƒç´ æ˜¯å¦æ­£ç¡®è·å–
      if (!previewPicture || !brandSelect) {
        console.error('DOMå…ƒç´ æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥HTMLç»“æ„');
        return;
      }
      
      // é¢„åŠ è½½å±•ç¤ºå›¾ç‰‡
      preloadExhibitionImages();
      
      // åˆå§‹åŒ–å“ç‰Œä¸‹æ‹‰åˆ—è¡¨
      initBrandSelect();
      
      // åˆå§‹åŒ–GitHubè§’è½
      initGithubCorner();
      
      // åŠ è½½éšæœºå›¾ç‰‡
      loadRandomImage();
      
      // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
      bindEventListeners();
    }
    
    // é¢„åŠ è½½å±•ç¤ºå›¾ç‰‡
    function preloadExhibitionImages() {
      console.log('é¢„åŠ è½½å±•ç¤ºå›¾ç‰‡...');
      ExhibitionImages.forEach(imgUrl => {
        const img = new Image();
        img.src = imgUrl;
      });
    }
    
    // åˆå§‹åŒ–å“ç‰Œä¸‹æ‹‰åˆ—è¡¨
    function initBrandSelect() {
      console.log('åˆå§‹åŒ–å“ç‰Œä¸‹æ‹‰åˆ—è¡¨...');
      
      // ç¡®ä¿brandSelectå…ƒç´ å·²è·å–
      if (!brandSelect) {
        console.error('brandSelectå…ƒç´ æœªæ‰¾åˆ°');
        return;
      }
      
      // æ¸…ç©ºç°æœ‰é€‰é¡¹
      brandSelect.innerHTML = '';
      
      // æ·»åŠ å“ç‰Œé€‰é¡¹
      BrandsList.forEach(brand => {
        const option = document.createElement('option');
        option.value = brand;
        option.textContent = brand;
        brandSelect.appendChild(option);
      });
      
      console.log(`å·²æ·»åŠ ${BrandsList.length}ä¸ªå“ç‰Œé€‰é¡¹`);
    }
    
    // åˆå§‹åŒ–GitHubè§’è½
    function initGithubCorner() {
      githubCornerDiv.innerHTML = `
        <a href="https://github.com/huashengyou92/photo-marks" class="github-corner" target="_blank" rel="noopener">
          <svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true">
            <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
            <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
            <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path>
          </svg>
        </a>
      `;
    }
    
    // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
    function bindEventListeners() {
      // æ–‡ä»¶ä¸Šä¼ æŒ‰é’®äº‹ä»¶
      document.getElementById('image-upload').addEventListener('change', handleImageUpload);
      
      // éšæœºå›¾ç‰‡æŒ‰é’®äº‹ä»¶
      document.getElementById('random-image').addEventListener('click', loadRandomImage);
      
      // è¡¨å•å˜æ›´äº‹ä»¶
      document.getElementById('exif-form').addEventListener('change', handleFormChange);
      
      // å­—ä½“å¤§å°å˜æ›´äº‹ä»¶
      document.getElementById('font-size').addEventListener('change', handleFontSizeChange);
      document.getElementById('font-size').addEventListener('input', handleFontSizeChange);
      
      // å­—ä½“ç²—ç»†å˜æ›´äº‹ä»¶
      document.getElementById('font-weight').addEventListener('change', handleFontWeightChange);
      document.getElementById('font-weight').addEventListener('input', handleFontWeightChange);
      
      // ä¸‹è½½æŒ‰é’®äº‹ä»¶
      document.getElementById('download-btn').addEventListener('click', handleDownload);
      
      // ä¸Šä¼ æŒ‰é’®äº‹ä»¶ - ç‚¹å‡»è§¦å‘æ–‡ä»¶é€‰æ‹©å™¨
      document.getElementById('upload-btn').addEventListener('click', function() {
        document.getElementById('image-upload').click();
      });
    }
    
    // åŠ è½½éšæœºå›¾ç‰‡
    function loadRandomImage() {
      const randomIndex = Math.floor(Math.random() * ExhibitionImages.length);
      const randomImageUrl = ExhibitionImages[randomIndex];
      
      console.log('åŠ è½½éšæœºå›¾ç‰‡:', randomImageUrl);
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      previewPicture.classList.remove('loaded');
      previewPicture.classList.add('loading');
      
      // åˆ›å»ºä¸€ä¸ªæ–°çš„Imageå¯¹è±¡æ¥é¢„åŠ è½½å›¾ç‰‡
      const img = new Image();
      
      img.onload = function() {
        console.log('éšæœºå›¾ç‰‡åŠ è½½æˆåŠŸ');
        // å›¾ç‰‡åŠ è½½å®Œæˆåï¼Œè®¾ç½®åˆ°é¢„è§ˆåŒºåŸŸ
        previewPicture.src = randomImageUrl;
        previewPicture.classList.remove('loading');
        previewPicture.classList.add('loaded');
        
        // è®¾ç½®é»˜è®¤è¡¨å•å€¼ï¼ˆè¿™é‡Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼‰
        const defaultValues = { ...DefaultPictureExif };
        updateFormValues(defaultValues);
        updatePreview();
      };
      
      img.onerror = function() {
        console.error('éšæœºå›¾ç‰‡åŠ è½½å¤±è´¥:', randomImageUrl);
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ç»™ç”¨æˆ·
        alert('æ— æ³•åŠ è½½ç¤ºä¾‹å›¾ç‰‡ï¼Œè¯·å°è¯•ä¸Šä¼ æ‚¨è‡ªå·±çš„å›¾ç‰‡');
        
        // å°è¯•ä½¿ç”¨é»˜è®¤å›¾ç‰‡
        previewPicture.src = 'public/simple.jpg';
        previewPicture.classList.remove('loading');
        previewPicture.classList.add('loaded');
        
        // ä½¿ç”¨é»˜è®¤å€¼
        updateFormValues(DefaultPictureExif);
        updatePreview();
      };
      
      // å¼€å§‹åŠ è½½å›¾ç‰‡
      img.src = randomImageUrl;
    }
    
    // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // ç«‹å³æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      previewPicture.classList.remove('loaded');
      previewPicture.classList.add('loading');
      
      // è·å–åŠ è½½æŒ‡ç¤ºå™¨
      const loadingIndicator = document.getElementById('loading-indicator');
      loadingIndicator.style.display = 'flex';
      
      // æ£€æŸ¥æ–‡ä»¶ç±»å‹
      const acceptedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/heic', 'image/heif'];
      
      // æ›´å¯é çš„æ–‡ä»¶ç±»å‹æ£€æµ‹ - åŒæ—¶æ£€æŸ¥MIMEç±»å‹å’Œæ–‡ä»¶æ‰©å±•å
      let isHeic = false;
      if (file.type === 'image/heic' || file.type === 'image/heif') {
        isHeic = true;
      } else if (file.type === '' || file.type === 'application/octet-stream') {
        // å½“æµè§ˆå™¨æ— æ³•è¯†åˆ«MIMEç±»å‹æ—¶ï¼Œæ£€æŸ¥æ–‡ä»¶æ‰©å±•å
        const fileName = file.name.toLowerCase();
        if (fileName.endsWith('.heic') || fileName.endsWith('.heif')) {
          isHeic = true;
        }
      }
      
      // å¯¹äºéæ¥å—çš„æ–‡ä»¶ç±»å‹ï¼Œæ˜¾ç¤ºé”™è¯¯
      if (!isHeic && !acceptedTypes.includes(file.type)) {
        alert('è¯·ä¸Šä¼ JPGã€JPEGã€PNGæˆ–HEICæ ¼å¼çš„å›¾ç‰‡\nEXIFæ•°æ®å¯ä»JPG/JPEGå’ŒHEICæ ¼å¼è¯»å–');
        previewPicture.classList.remove('loading');
        loadingIndicator.style.display = 'none';
        return;
      }
      
      // æå‰æ˜¾ç¤ºæ–‡ä»¶ç±»å‹è­¦å‘Š
      if (file.type === 'image/png') {
        console.log('PNGå›¾ç‰‡ä¸åŒ…å«EXIFæ•°æ®ï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼');
      }
      
      // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º10MBï¼‰
      if (file.size > 10 * 1024 * 1024) {
        alert('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·ä¸Šä¼ å°äº10MBçš„å›¾ç‰‡');
        previewPicture.classList.remove('loading');
        loadingIndicator.style.display = 'none';
        return;
      }
      
      // å¤„ç†HEIC/HEIFæ ¼å¼
      if (isHeic) {
        console.log('æ£€æµ‹åˆ°HEIC/HEIFæ ¼å¼å›¾ç‰‡');
        loadingIndicator.textContent = 'æ£€æµ‹åˆ°HEICå›¾ç‰‡...';
        
        // æ£€æŸ¥HEICåº“æ˜¯å¦å·²åŠ è½½
        if (!isHeicLibLoaded()) {
          if (window.heicLibLoading) {
            // å¦‚æœåº“æ­£åœ¨åŠ è½½ä¸­ï¼Œç­‰å¾…åŠ è½½å®Œæˆ
            loadingIndicator.textContent = 'HEICè½¬æ¢åº“æ­£åœ¨åŠ è½½ï¼Œè¯·ç¨å€™...';
            let checkCount = 0;
            const maxChecks = 20; // æœ€å¤šç­‰å¾…10ç§’
            
            const checkInterval = setInterval(function() {
              if (isHeicLibLoaded()) {
                clearInterval(checkInterval);
                console.log('HEICåº“å·²åŠ è½½å®Œæˆï¼Œå¼€å§‹è½¬æ¢...');
                loadingIndicator.textContent = 'HEICåº“åŠ è½½å®Œæˆï¼Œå¼€å§‹è½¬æ¢...';
                processHeicFile(file, loadingIndicator);
              } else if (checkCount >= maxChecks || !window.heicLibLoading) {
                clearInterval(checkInterval);
                console.error('HEICåº“åŠ è½½è¶…æ—¶æˆ–å¤±è´¥');
                loadingIndicator.textContent = 'HEICåº“åŠ è½½å¤±è´¥';
                alert('HEICè½¬æ¢åº“åŠ è½½å¤±è´¥ï¼Œè¯·ä½¿ç”¨JPGæ ¼å¼å›¾ç‰‡æˆ–å…ˆå°†HEICè½¬æ¢ä¸ºJPGæ ¼å¼');
                previewPicture.classList.remove('loading');
                loadingIndicator.style.display = 'none';
              }
              checkCount++;
            }, 500);
          } else {
            // å°è¯•åŠ è½½HEICåº“
            loadingIndicator.textContent = 'åŠ è½½HEICè½¬æ¢åº“...';
            loadHeicLib();
            
            setTimeout(function() {
              if (isHeicLibLoaded()) {
                processHeicFile(file, loadingIndicator);
              } else {
                console.error('HEICåº“åŠ è½½å¤±è´¥');
                loadingIndicator.textContent = 'HEICåº“åŠ è½½å¤±è´¥';
                alert('æ— æ³•åŠ è½½HEICè½¬æ¢åº“ï¼Œè¯·ä½¿ç”¨JPGæ ¼å¼å›¾ç‰‡æˆ–å…ˆå°†HEICè½¬æ¢ä¸ºJPGæ ¼å¼\næ¨èä½¿ç”¨åœ¨çº¿è½¬æ¢å·¥å…·æˆ–åº”ç”¨è¿›è¡Œé¢„å¤„ç†');
                previewPicture.classList.remove('loading');
                loadingIndicator.style.display = 'none';
              }
            }, 3000);
          }
        } else {
          // HEICåº“å·²åŠ è½½ï¼Œç›´æ¥å¤„ç†
          processHeicFile(file, loadingIndicator);
        }
      } else {
        // ç›´æ¥å¤„ç†JPG/JPEG/PNGæ–‡ä»¶
        loadingIndicator.style.display = 'none';
        processImageFile(file);
      }
    }
    
    // å¤„ç†HEICæ–‡ä»¶çš„å‡½æ•°
    function processHeicFile(file, loadingIndicator) {
      loadingIndicator.textContent = 'HEICå›¾ç‰‡è½¬æ¢ä¸­...';
      console.log('å¼€å§‹è½¬æ¢HEICå›¾ç‰‡...');
      
      try {
        // é¦–å…ˆå°è¯•ä»åŸå§‹HEICæ–‡ä»¶è§£æEXIFæ•°æ®
        parseExifFromImage(file)
          .then(exifDataFromHeic => {
            console.log('ä»HEICæ–‡ä»¶æå–çš„EXIFæ•°æ®:', exifDataFromHeic);
            
            // ç„¶åå¼€å§‹è½¬æ¢HEICä¸ºJPEG
            loadingIndicator.textContent = 'æå–EXIFå®Œæˆï¼Œæ­£åœ¨è½¬æ¢æ ¼å¼...';
            
            heic2any({
              blob: file,
              toType: 'image/jpeg',
              quality: 0.8
            })
            .then(convertedBlob => {
              console.log('HEICè½¬æ¢æˆåŠŸï¼Œå¤§å°: ' + convertedBlob.size);
              loadingIndicator.textContent = 'HEICè½¬æ¢æˆåŠŸ!';
              
              // ä¸ºè½¬æ¢åçš„Blobå¯¹è±¡åˆ›å»ºä¸€ä¸ªæ–°çš„Fileå¯¹è±¡
              const convertedFile = new File([convertedBlob], file.name.replace(/\.(heic|heif)$/i, '.jpg'), {
                type: 'image/jpeg',
                lastModified: new Date().getTime()
              });
              
              // é‡è¦ï¼šæ ‡è®°æ­¤æ–‡ä»¶ä¸ºå·²è½¬æ¢HEICï¼Œä»¥ä¾¿åœ¨processImageFileä¸­å¤„ç†
              convertedFile._convertedFromHeic = true;
              convertedFile._heicExifData = exifDataFromHeic;
              
              // ä½¿ç”¨è½¬æ¢åçš„JPEGæ–‡ä»¶è¿›è¡Œå¤„ç†
              processImageFile(convertedFile);
              
              // éšè—åŠ è½½æŒ‡ç¤ºå™¨
              setTimeout(() => {
                loadingIndicator.style.display = 'none';
              }, 1000);
            })
            .catch(err => {
              console.error('HEICè½¬æ¢å¤±è´¥:', err);
              loadingIndicator.textContent = 'HEICè½¬æ¢å¤±è´¥';
              alert('HEICå›¾ç‰‡è½¬æ¢å¤±è´¥: ' + (err.message || 'æœªçŸ¥é”™è¯¯') + '\nè¯·å°è¯•å°†HEICå›¾ç‰‡è½¬æ¢ä¸ºJPGæ ¼å¼åå†ä¸Šä¼ ');
              previewPicture.classList.remove('loading');
              loadingIndicator.style.display = 'none';
            });
          })
          .catch(error => {
            console.error('ä»HEICè§£æEXIFæ•°æ®å¤±è´¥ï¼Œç»§ç»­è½¬æ¢æµç¨‹:', error);
            loadingIndicator.textContent = 'EXIFæå–å¤±è´¥ï¼Œå°è¯•ç›´æ¥è½¬æ¢...';
            
            // ä»ç„¶å°è¯•è½¬æ¢HEICä¸ºJPEG
            heic2any({
              blob: file,
              toType: 'image/jpeg',
              quality: 0.8
            })
            .then(convertedBlob => {
              console.log('HEICè½¬æ¢æˆåŠŸï¼Œå¤§å°: ' + convertedBlob.size);
              loadingIndicator.textContent = 'HEICè½¬æ¢æˆåŠŸ!';
              
              // ä¸ºè½¬æ¢åçš„Blobå¯¹è±¡åˆ›å»ºä¸€ä¸ªæ–°çš„Fileå¯¹è±¡
              const convertedFile = new File([convertedBlob], file.name.replace(/\.(heic|heif)$/i, '.jpg'), {
                type: 'image/jpeg',
                lastModified: new Date().getTime()
              });
              
              // ä½¿ç”¨è½¬æ¢åçš„JPEGæ–‡ä»¶è¿›è¡Œå¤„ç†
              processImageFile(convertedFile);
              
              // éšè—åŠ è½½æŒ‡ç¤ºå™¨
              setTimeout(() => {
                loadingIndicator.style.display = 'none';
              }, 1000);
            })
            .catch(err => {
              console.error('HEICè½¬æ¢å¤±è´¥:', err);
              loadingIndicator.textContent = 'HEICè½¬æ¢å¤±è´¥';
              alert('HEICå›¾ç‰‡è½¬æ¢å¤±è´¥: ' + (err.message || 'æœªçŸ¥é”™è¯¯') + '\nè¯·å°è¯•å°†HEICå›¾ç‰‡è½¬æ¢ä¸ºJPGæ ¼å¼åå†ä¸Šä¼ ');
              previewPicture.classList.remove('loading');
              loadingIndicator.style.display = 'none';
            });
          });
      } catch (error) {
        console.error('HEICåº“è°ƒç”¨å¤±è´¥:', error);
        loadingIndicator.textContent = 'HEICè½¬æ¢å‡ºé”™';
        alert('HEICè½¬æ¢è¿‡ç¨‹ä¸­å‡ºé”™ï¼Œè¯·ä½¿ç”¨å…¶ä»–æ ¼å¼æˆ–å…ˆå°†HEICè½¬æ¢ä¸ºJPGåä¸Šä¼ ');
        previewPicture.classList.remove('loading');
        loadingIndicator.style.display = 'none';
      }
    }
    
    // å¤„ç†å›¾ç‰‡æ–‡ä»¶ï¼ˆæå–å…±ç”¨é€»è¾‘ï¼‰
    function processImageFile(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const imgUrl = e.target.result;
        
        // åˆ›å»ºä¸€ä¸ªæ–°çš„Imageå¯¹è±¡æ¥é¢„åŠ è½½å›¾ç‰‡
        const img = new Image();
        img.onload = function() {
          // å›¾ç‰‡åŠ è½½å®Œæˆåï¼Œè®¾ç½®åˆ°é¢„è§ˆåŒºåŸŸ
          previewPicture.src = imgUrl;
          previewPicture.classList.remove('loading');
          previewPicture.classList.add('loaded');
          
          // é¦–å…ˆä½¿ç”¨é»˜è®¤å€¼ï¼Œä»¥é˜²è§£æå¤±è´¥
          updateFormValues(DefaultPictureExif);
          
          // æ£€æŸ¥æ˜¯å¦æ˜¯ä»HEICè½¬æ¢çš„æ–‡ä»¶ä¸”å·²æœ‰EXIFæ•°æ®
          if (file._convertedFromHeic && file._heicExifData) {
            console.log('ä½¿ç”¨ä»HEICæ–‡ä»¶æå–çš„EXIFæ•°æ®');
            const exifData = file._heicExifData;
            // æ£€æŸ¥è§£æå‡ºçš„EXIFæ•°æ®æ˜¯å¦æœ‰æ•ˆ
            const hasValidData = exifData.brand || exifData.model || 
                               exifData.date !== formatDate(new Date()) || 
                               exifData.device || exifData.gps;
            
            if (hasValidData) {
              updateFormValues(exifData);
              updatePreview();
            } else {
              console.warn('ä»HEICæå–çš„EXIFæ•°æ®æ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤å€¼');
            }
          }
          // å¯¹äºJPG/JPEGå’Œæ— å·²æå–EXIFçš„è½¬æ¢æ–‡ä»¶ï¼Œè§£æEXIFæ•°æ®
          else if (file.type === 'image/jpeg' || file.type === 'image/jpg') {
            console.log('å¼€å§‹ä»JPG/JPEGå›¾ç‰‡è§£æEXIFæ•°æ®...');
            
            parseExifFromImage(file)
              .then(exifData => {
                console.log('æˆåŠŸè§£æEXIFæ•°æ®:', exifData);
                // æ£€æŸ¥è§£æå‡ºçš„EXIFæ•°æ®æ˜¯å¦æœ‰æ•ˆ
                const hasValidData = exifData.brand || exifData.model || 
                                   exifData.date !== formatDate(new Date()) || 
                                   exifData.device || exifData.gps;
                
                if (hasValidData) {
                  updateFormValues(exifData);
                  updatePreview();
                } else {
                  console.warn('è§£æçš„EXIFæ•°æ®æ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤å€¼');
                }
              })
              .catch(error => {
                console.error('è§£æEXIFæ•°æ®å¤±è´¥:', error);
              });
          } else {
            // å¯¹äºPNGæ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨é»˜è®¤å€¼
            console.log('éJPGæ ¼å¼ï¼Œä½¿ç”¨é»˜è®¤å€¼');
          }
          
          // å§‹ç»ˆæ›´æ–°é¢„è§ˆ
          updatePreview();
        };
        
        img.onerror = function() {
          console.error('åŠ è½½ä¸Šä¼ å›¾ç‰‡å¤±è´¥');
          previewPicture.classList.remove('loading');
          alert('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·å°è¯•å…¶ä»–å›¾ç‰‡');
          // å¦‚æœè§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼
          updateFormValues(DefaultPictureExif);
          updatePreview();
        };
        
        // å¼€å§‹åŠ è½½å›¾ç‰‡
        img.src = imgUrl;
      };
      
      reader.onerror = function() {
        console.error('è¯»å–æ–‡ä»¶å¤±è´¥');
        previewPicture.classList.remove('loading');
        alert('è¯»å–å›¾ç‰‡æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•');
      };
      
      reader.readAsDataURL(file);
    }
    
    // è§£æå›¾ç‰‡EXIFæ•°æ®çš„å‡½æ•°
    function parseExifFromImage(file) {
      return new Promise((resolve, reject) => {
        try {
          console.log('å¼€å§‹è§£æEXIFæ•°æ®ï¼Œæ–‡ä»¶ç±»å‹:', file.type);
          
          // ç¡®ä¿EXIF.jsåº“å·²åŠ è½½
          if (typeof EXIF === 'undefined') {
            console.error('EXIFåº“æœªåŠ è½½');
            return reject('EXIFåº“æœªåŠ è½½');
          }
          
          // åˆå§‹åŒ–é»˜è®¤æ•°æ®å¯¹è±¡
          const exifData = {
            brand: '',
            model: '',
            date: formatDate(new Date()),
            device: '',
            gps: ''
          };
          
          // å¤„ç†HEICæ–‡ä»¶ç±»å‹ - ä½¿ç”¨ArrayBufferæ–¹å¼
          if (file.type === 'image/heic' || file.type === 'image/heif') {
            const reader = new FileReader();
            reader.onload = function(e) {
              try {
                const arrayBuffer = e.target.result;
                // ä½¿ç”¨EXIF.jsè§£æäºŒè¿›åˆ¶æ•°æ®
                let tags = EXIF.readFromBinaryFile(arrayBuffer);
                
                // è¾“å‡ºå®Œæ•´çš„HEICæ ‡ç­¾ï¼Œç”¨äºè°ƒè¯•
                console.log('========== HEICåŸå§‹EXIFæ•°æ®å¼€å§‹ ==========');
                console.log('æ–‡ä»¶åç§°:', file.name);
                console.log('æ–‡ä»¶å¤§å°:', (file.size / 1024 / 1024).toFixed(2) + 'MB');
                
                // æ‰“å°æ‰€æœ‰æ ‡ç­¾ï¼Œç‰¹åˆ«å…³æ³¨åŒ…å«å‹å·ä¿¡æ¯çš„å¯èƒ½å­—æ®µ
                for (let key in tags) {
                  const value = tags[key];
                  console.log(`${key}: ${typeof value === 'object' ? JSON.stringify(value) : value}`);
                  
                  // æ£€æŸ¥å¯¹è±¡ç±»å‹çš„æ ‡ç­¾ï¼Œå¯èƒ½åŒ…å«å‹å·ä¿¡æ¯
                  if (typeof value === 'object' && value !== null) {
                    for (let subKey in value) {
                      if (typeof value[subKey] === 'string' && 
                          (subKey.toLowerCase().includes('model') || 
                           value[subKey].toLowerCase().includes('iphone') ||
                           value[subKey].toLowerCase().includes('canon') ||
                           value[subKey].toLowerCase().includes('nikon') ||
                           value[subKey].toLowerCase().includes('sony'))) {
                        console.log(`å‘ç°æ½œåœ¨å‹å·ä¿¡æ¯ - ${key}.${subKey}: ${value[subKey]}`);
                      }
                    }
                  }
                }
                console.log('========== HEICåŸå§‹EXIFæ•°æ®ç»“æŸ ==========');

                // ç‰¹æ®Šå¤„ç†HEICæ–‡ä»¶çš„ç›¸æœºå‹å· - æ‰©å±•æ£€æµ‹é€»è¾‘
                if (!tags.Model) {
                  console.log('æœªæ‰¾åˆ°æ ‡å‡†Modelå­—æ®µï¼Œå°è¯•ä»å…¶ä»–å­—æ®µæå–...');
                  
                  // å°è¯•ä»å¤‡ç”¨å­—æ®µè·å–å‹å·ä¿¡æ¯
                  if (tags.CanonModelID) {
                    tags.Model = "Canon " + tags.CanonModelID;
                  } else if (tags.CanonModelName) {
                    tags.Model = tags.CanonModelName;
                  } else if (tags.SonyModelID) {
                    tags.Model = "Sony " + tags.SonyModelID;
                  } else if (tags.NikonModelID) {
                    tags.Model = "Nikon " + tags.NikonModelID;
                  } else if (tags.FujiModelID) {
                    tags.Model = "Fujifilm " + tags.FujiModelID;
                  } else if (tags.Apple && tags.Apple.length > 0) {
                    // å¯¹äºiPhoneç…§ç‰‡ï¼Œå°è¯•æå–å‹å·
                    tags.Model = "iPhone";
                    // å°è¯•æŸ¥æ‰¾å®Œæ•´å‹å·ä¿¡æ¯
                    for (let i = 0; i < tags.Apple.length; i++) {
                      if (tags.Apple[i] && typeof tags.Apple[i] === 'string' && 
                          (tags.Apple[i].includes('iPhone') || tags.Apple[i].includes('iPad'))) {
                        tags.Model = tags.Apple[i];
                        break;
                      }
                    }
                  } 
                  // å°è¯•åœ¨æ ‡ç­¾ä¸­æœç´¢ä»»ä½•å¯èƒ½åŒ…å«å‹å·ä¿¡æ¯çš„å­—æ®µ
                  else {
                    // æŸ¥æ‰¾ä»»ä½•åŒ…å«"model"çš„é”®
                    const modelKeys = Object.keys(tags).filter(key => 
                      key.toLowerCase().includes('model') || 
                      (key.toLowerCase().includes('description') && tags[key])
                    );
                    
                    if (modelKeys.length > 0) {
                      console.log('å‘ç°å¯èƒ½çš„å‹å·ä¿¡æ¯å­—æ®µ:', modelKeys);
                      // ä½¿ç”¨ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„å­—æ®µ
                      for (const key of modelKeys) {
                        if (tags[key] && typeof tags[key] === 'string') {
                          tags.Model = tags[key];
                          console.log('ä½¿ç”¨æ›¿ä»£å­—æ®µä½œä¸ºå‹å·:', key, tags.Model);
                          break;
                        }
                      }
                    }
                  }
                  
                  // å¦‚æœä»¥ä¸Šéƒ½å¤±è´¥ï¼Œä½¿ç”¨å“ç‰Œä¿¡æ¯
                  if (!tags.Model && tags.Make) {
                    // å¦‚æœåªæœ‰å“ç‰Œæ²¡æœ‰å‹å·ï¼Œå°è¯•ä»å…¶ä»–æ•°æ®æ¨æ–­
                    const makeUpper = tags.Make.toUpperCase();
                    if (makeUpper.includes('APPLE')) {
                      // ç‰¹æ®Šå¤„ç†è‹¹æœè®¾å¤‡
                      if (tags.ImageDescription && typeof tags.ImageDescription === 'string') {
                        if (tags.ImageDescription.includes('iPhone')) {
                          const match = tags.ImageDescription.match(/(iPhone\s*\d+\S*)/i);
                          if (match) {
                            tags.Model = match[1];
                          } else {
                            tags.Model = 'iPhone';
                          }
                        } else {
                          tags.Model = 'iPhone';
                        }
                      } else {
                        tags.Model = 'iPhone';
                      }
                    } else if (makeUpper.includes('SAMSUNG')) {
                      tags.Model = 'Galaxy'; // é»˜è®¤Samsungä¸ºGalaxyç³»åˆ—
                    } else if (makeUpper.includes('HUAWEI')) {
                      tags.Model = 'Huawei Phone';
                    } else if (makeUpper.includes('XIAOMI')) {
                      tags.Model = 'Xiaomi Phone';
                    } else {
                      // å°è¯•ä½¿ç”¨ç›¸æœºå¯¹åº”çš„é»˜è®¤å‹å·
                      if (makeUpper.includes('CANON')) {
                        tags.Model = 'EOS'; // Canonå¸¸è§ç³»åˆ—
                      } else if (makeUpper.includes('NIKON')) {
                        tags.Model = 'Nikon Camera';
                      } else if (makeUpper.includes('SONY')) {
                        tags.Model = 'Alpha'; // Sonyå¸¸è§ç³»åˆ—
                      } else if (makeUpper.includes('FUJI') || makeUpper.includes('FUJIFILM')) {
                        tags.Model = 'X Series'; // Fujiå¸¸è§ç³»åˆ—
                      } else if (makeUpper.includes('OLYMPUS')) {
                        tags.Model = 'OM-D'; // Olympuså¸¸è§ç³»åˆ—
                      } else {
                        tags.Model = tags.Make + ' Camera'; // é€šç”¨åå¤‡é€‰é¡¹
                      }
                    }
                    console.log('åŸºäºå“ç‰Œæ¨æ–­çš„å‹å·:', tags.Model);
                  }
                }
                
                // ç¡®ä¿å“ç‰Œå’Œå‹å·éƒ½æœ‰å€¼
                if (tags.Model && !tags.Make) {
                  // å¦‚æœåªæœ‰å‹å·æ²¡æœ‰å“ç‰Œï¼Œå°è¯•ä»å‹å·æå–å“ç‰Œ
                  if (tags.Model.includes('iPhone') || tags.Model.includes('iPad')) {
                    tags.Make = 'Apple';
                  } else if (tags.Model.includes('Galaxy')) {
                    tags.Make = 'Samsung';
                  } else if (tags.Model.toLowerCase().includes('canon')) {
                    tags.Make = 'Canon';
                  } else if (tags.Model.toLowerCase().includes('nikon')) {
                    tags.Make = 'Nikon';
                  } else if (tags.Model.toLowerCase().includes('sony')) {
                    tags.Make = 'Sony';
                  }
                }
                
                console.log('æœ€ç»ˆæå–çš„å“ç‰Œå’Œå‹å·:', tags.Make, tags.Model);
                processExifTags(tags, exifData, resolve);
              } catch (err) {
                console.error('HEIC EXIFè§£æé”™è¯¯:', err);
                resolve(exifData); // è¿”å›é»˜è®¤æ•°æ®
              }
            };
            reader.onerror = function() {
              console.error('è¯»å–HEICæ–‡ä»¶å¤±è´¥');
              resolve(exifData); // è¿”å›é»˜è®¤æ•°æ®
            };
            reader.readAsArrayBuffer(file);
          } 
          // å¤„ç†JPGæ–‡ä»¶ç±»å‹ - ä½¿ç”¨æ ‡å‡†çš„EXIF.getDataæ–¹æ³•
          else {
            // åˆ›å»ºä¸€ä¸ªURLä»¥åŠ è½½å›¾åƒ
            const url = URL.createObjectURL(file);
            const img = new Image();
            
            img.onload = function() {
              try {
                EXIF.getData(img, function() {
                  console.log('JPGåŸå§‹EXIFæ•°æ®:', this.exifdata);
                  const tags = this.exifdata;
                  processExifTags(tags, exifData, resolve);
                  
                  // æ·»åŠ æ›´å¤šè°ƒè¯•ä¿¡æ¯
                  if (Object.keys(tags).length === 0) {
                    console.warn('JPGå›¾ç‰‡æ²¡æœ‰EXIFæ•°æ® - å›¾ç‰‡å¯èƒ½å·²è¢«å¤„ç†æˆ–æ¥è‡ªä¸å†™å…¥å…ƒæ•°æ®çš„åº”ç”¨');
                  }
                });
              } catch (err) {
                console.error('JPG EXIFè§£æé”™è¯¯:', err);
                resolve(exifData); // è¿”å›é»˜è®¤æ•°æ®
              } finally {
                // æ¸…ç†URLå¯¹è±¡
                URL.revokeObjectURL(url);
              }
            };
            
            img.onerror = function() {
              console.error('åŠ è½½JPGå›¾ç‰‡å¤±è´¥');
              URL.revokeObjectURL(url);
              resolve(exifData); // è¿”å›é»˜è®¤æ•°æ®
            };
            
            img.src = url;
          }
          
        } catch (error) {
          console.error('è§£æEXIFè¿‡ç¨‹ä¸­å‡ºé”™:', error);
          reject(error);
        }
      });
    }
    
    // å¤„ç†EXIFæ ‡ç­¾ - æå–ä¸ºå•ç‹¬å‡½æ•°ä»¥é¿å…ä»£ç é‡å¤
    function processExifTags(tags, exifData, resolve) {
      if (!tags || Object.keys(tags).length === 0) {
        console.warn('æœªæ‰¾åˆ°EXIFæ•°æ®æˆ–EXIFæ•°æ®ä¸ºç©º');
        return resolve(exifData); // è¿”å›é»˜è®¤æ•°æ®
      }
      
      // æå–å“ç‰Œå’Œå‹å·ä¿¡æ¯
      if (tags.Make) {
        exifData.brand = tags.Make.trim();
        console.log('ç›¸æœºå“ç‰Œ:', exifData.brand);
      }
      
      if (tags.Model) {
        // ç§»é™¤å‹å·ä¸­å¯èƒ½åŒ…å«çš„å“ç‰Œåç§°ï¼Œé¿å…é‡å¤
        let modelStr = tags.Model.trim();
        if (exifData.brand && modelStr.startsWith(exifData.brand)) {
          modelStr = modelStr.substring(exifData.brand.length).trim();
        }
        
        exifData.model = modelStr;
        console.log('ç›¸æœºå‹å·:', exifData.model);
      }
      
      // æå–è®¾å¤‡ä¿¡æ¯ (ç»„åˆå…‰åœˆã€å¿«é—¨é€Ÿåº¦å’ŒISO)
      let deviceInfo = [];
      
      // å…‰åœˆå€¼
      if (tags.FNumber) {
        let fNumber;
        if (typeof tags.FNumber === 'number') {
          fNumber = tags.FNumber;
        } else if (tags.FNumber && tags.FNumber.numerator && tags.FNumber.denominator) {
          fNumber = tags.FNumber.numerator / tags.FNumber.denominator;
        }
        
        if (fNumber) {
          deviceInfo.push('f/' + fNumber.toFixed(1));
        }
      }
      
      // å¿«é—¨é€Ÿåº¦
      if (tags.ExposureTime) {
        let exposureTime;
        if (typeof tags.ExposureTime === 'number') {
          exposureTime = tags.ExposureTime;
        } else if (tags.ExposureTime && tags.ExposureTime.numerator && tags.ExposureTime.denominator) {
          exposureTime = tags.ExposureTime.numerator / tags.ExposureTime.denominator;
        }
        
        if (exposureTime) {
          // æ ¼å¼åŒ–å¿«é—¨é€Ÿåº¦ä¸ºåˆ†æ•°å½¢å¼ (å¦‚1/125)
          if (exposureTime < 1) {
            const denominator = Math.round(1 / exposureTime);
            deviceInfo.push('1/' + denominator + 's');
          } else {
            deviceInfo.push(exposureTime.toFixed(1) + 's');
          }
        }
      }
      
      // ISOå€¼
      if (tags.ISOSpeedRatings) {
        deviceInfo.push('ISO' + tags.ISOSpeedRatings);
      }
      
      exifData.device = deviceInfo.join(' ');
      console.log('è®¾å¤‡ä¿¡æ¯:', exifData.device);
      
      // æå–æ—¥æœŸä¿¡æ¯
      if (tags.DateTimeOriginal) {
        const dateParts = tags.DateTimeOriginal.split(' ');
        if (dateParts.length >= 1) {
          const dateStr = dateParts[0].replace(/:/g, '-');
          exifData.date = dateStr;
          console.log('æ‹æ‘„æ—¥æœŸ:', exifData.date);
        }
      }
      
      // æå–GPSä¿¡æ¯
      if (tags.GPSLatitude && tags.GPSLongitude && 
          tags.GPSLatitudeRef && tags.GPSLongitudeRef) {
        
        function convertDMSToDD(degrees, minutes, seconds, direction) {
          let dd = degrees + minutes/60 + seconds/3600;
          if (direction === 'S' || direction === 'W') {
            dd = dd * -1;
          }
          return dd;
        }
        
        // è§£æçº¬åº¦
        const latDegrees = tags.GPSLatitude[0];
        const latMinutes = tags.GPSLatitude[1];
        const latSeconds = tags.GPSLatitude[2];
        const latDirection = tags.GPSLatitudeRef;
        
        // è§£æç»åº¦
        const lonDegrees = tags.GPSLongitude[0];
        const lonMinutes = tags.GPSLongitude[1];
        const lonSeconds = tags.GPSLongitude[2];
        const lonDirection = tags.GPSLongitudeRef;
        
        const latitude = convertDMSToDD(latDegrees, latMinutes, latSeconds, latDirection);
        const longitude = convertDMSToDD(lonDegrees, lonMinutes, lonSeconds, lonDirection);
        
        exifData.gps = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
        console.log('GPSåæ ‡:', exifData.gps);
      }
      
      resolve(exifData);
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸå‡½æ•°
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    // æ›´æ–°è¡¨å•å€¼
    function updateFormValues(values) {
      console.log('æ›´æ–°è¡¨å•å€¼:', values);
      
      // æ›´æ–°å½“å‰è¡¨å•å€¼
      currentFormValues = { ...currentFormValues, ...values };
      
      // æ›´æ–°è¡¨å•è¾“å…¥
      document.getElementById('model').value = currentFormValues.model || '';
      document.getElementById('device').value = currentFormValues.device || '';
      document.getElementById('date').value = currentFormValues.date || '';
      document.getElementById('gps').value = currentFormValues.gps || '';
      
      // æ›´æ–°å“ç‰Œé€‰æ‹©å™¨
      const brandSelect = document.getElementById('brand');
      if (brandSelect) {
        // åœ¨è®¾ç½®å‰æ£€æŸ¥å“ç‰Œæ˜¯å¦åœ¨åˆ—è¡¨ä¸­
        const brandValue = currentFormValues.brand || 'æœªæ”¶å½•';
        
        // æ‰¾åˆ°å¯¹åº”çš„é€‰é¡¹å¹¶è®¾ç½®
        let found = false;
        for (let i = 0; i < brandSelect.options.length; i++) {
          if (brandSelect.options[i].value === brandValue) {
            brandSelect.selectedIndex = i;
            found = true;
            break;
          }
        }
        
        // å¦‚æœæ²¡æ‰¾åˆ°åŒ¹é…çš„é€‰é¡¹ï¼Œé»˜è®¤é€‰æ‹©"æœªæ”¶å½•"
        if (!found) {
          console.log(`å“ç‰Œ'${brandValue}'æœªåœ¨åˆ—è¡¨ä¸­æ‰¾åˆ°ï¼Œä½¿ç”¨é»˜è®¤å€¼`);
          for (let i = 0; i < brandSelect.options.length; i++) {
            if (brandSelect.options[i].value === 'æœªæ”¶å½•') {
              brandSelect.selectedIndex = i;
              currentFormValues.brand = 'æœªæ”¶å½•';
              break;
            }
          }
        }
      } else {
        console.error('å“ç‰Œé€‰æ‹©å™¨å…ƒç´ æœªæ‰¾åˆ°');
      }
    }
    
    // å¤„ç†è¡¨å•å˜æ›´
    function handleFormChange(event) {
      const { name, value } = event.target;
      console.log(`è¡¨å•å˜æ›´: ${name} = ${value}`);
      
      // æ›´æ–°å½“å‰å€¼
      currentFormValues[name] = value;
      
      // å¦‚æœæ˜¯å“ç‰Œå‘ç”Ÿå˜åŒ–ï¼Œè‡ªåŠ¨æ›´æ–°å…¶ä»–ä¿¡æ¯
      if (name === 'brand' && BrandDefaultInfo[value]) {
        console.log(`å“ç‰Œå˜æ›´ä¸º: ${value}ï¼Œæ­£åœ¨æ›´æ–°ç›¸å…³ä¿¡æ¯`);
        
        // è·å–æ‰€é€‰å“ç‰Œçš„é»˜è®¤ä¿¡æ¯
        const brandDefaults = BrandDefaultInfo[value];
        
        // æ›´æ–°è¡¨å•å’Œå½“å‰å€¼
        document.getElementById('model').value = brandDefaults.model;
        document.getElementById('device').value = brandDefaults.device;
        document.getElementById('date').value = brandDefaults.date;
        document.getElementById('gps').value = brandDefaults.gps;
        
        // åŒæ­¥æ›´æ–°å½“å‰è¡¨å•å€¼å¯¹è±¡
        currentFormValues = {
          ...currentFormValues,
          model: brandDefaults.model,
          device: brandDefaults.device,
          date: brandDefaults.date,
          gps: brandDefaults.gps
        };
        
        console.log('æ›´æ–°åçš„è¡¨å•å€¼:', currentFormValues);
      }
      
      // æ›´æ–°é¢„è§ˆ
      updatePreview();
    }
    
    // å¤„ç†å­—ä½“å¤§å°å˜æ›´
    function handleFontSizeChange(event) {
      const value = event.target.value;
      document.documentElement.style.setProperty('--current-font-size', value / 16);
    }
    
    // å¤„ç†å­—ä½“ç²—ç»†å˜æ›´
    function handleFontWeightChange(event) {
      const value = event.target.value;
      document.documentElement.style.setProperty('--current-font-weight', value);
    }
    
    // è·å–å“ç‰Œå›¾æ ‡URL
    function getBrandUrl(brand) {
      console.log('è·å–å“ç‰Œå›¾æ ‡:', brand);
      
      // å¦‚æœå“ç‰Œä¸ºç©ºï¼Œè¿”å›æœªçŸ¥å›¾æ ‡
      if (!brand) {
        console.warn('å“ç‰Œä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å›¾æ ‡');
        return 'public/brand/unknow.svg';
      }
      
      // ä»BrandsMapè·å–æ–‡ä»¶å
      const fileName = BrandsMap[brand] || 'unknow';
      const url = `public/brand/${fileName}.svg`;
      
      console.log('å›¾æ ‡URL:', url);
      return url;
    }
    
    // æ›´æ–°é¢„è§ˆ
    function updatePreview() {
      // æ›´æ–°æ–‡æœ¬å†…å®¹
      infoModel.textContent = currentFormValues.model || '';
      infoDate.textContent = currentFormValues.date || '';
      infoDevice.textContent = currentFormValues.device || '';
      infoGps.textContent = currentFormValues.gps || '';
      
      // è·å–å“ç‰Œå›¾æ ‡URL
      const brandUrl = getBrandUrl(currentFormValues.brand);
      
      // è®¾ç½®å“ç‰Œå›¾æ ‡
      if (brandUrl) {
        infoBrandImg.style.display = 'block';
        infoBrandImg.src = brandUrl;
        
        // æ·»åŠ å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç†
        infoBrandImg.onerror = function() {
          console.error('å“ç‰Œå›¾æ ‡åŠ è½½å¤±è´¥:', brandUrl);
          // ä½¿ç”¨é»˜è®¤å›¾æ ‡
          infoBrandImg.src = 'public/brand/unknow.svg';
          
          // äºŒæ¬¡é”™è¯¯å¤„ç† - å¦‚æœé»˜è®¤å›¾æ ‡ä¹ŸåŠ è½½å¤±è´¥
          infoBrandImg.onerror = function() {
            console.error('é»˜è®¤å›¾æ ‡ä¹ŸåŠ è½½å¤±è´¥');
            infoBrandImg.style.display = 'none'; // éšè—å›¾ç‰‡
          };
        };
      } else {
        // å¦‚æœæ²¡æœ‰å“ç‰ŒURLï¼Œéšè—å›¾ç‰‡
        infoBrandImg.style.display = 'none';
      }
    }
    
    // å¤„ç†ä¸‹è½½
    function handleDownload() {
      const preview = document.getElementById('preview');
      
      if (typeof domtoimage === 'undefined') {
        console.error('æ‰¾ä¸åˆ°dom-to-imageåº“ï¼Œè¯·ç¡®ä¿å·²æ­£ç¡®åŠ è½½');
        alert('ä¸‹è½½åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯');
        return;
      }
      
      domtoimage.toBlob(preview)
        .then(function(blob) {
          const link = document.createElement('a');
          link.download = `${currentFormValues.model}-${currentFormValues.date.replace(/[\s:]/g, '-')}.png`;
          link.href = URL.createObjectURL(blob);
          link.click();
        })
        .catch(function(error) {
          console.error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥:', error);
          alert('ç”Ÿæˆå›¾ç‰‡å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯');
        });
    }
    
    // åŠ è½½å›¾ç‰‡å‡½æ•°
    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = src;
      });
    }
    
    // åˆå§‹åŒ–åº”ç”¨
    document.addEventListener('DOMContentLoaded', init);
  </script>

  <style>
    .file-hint {
      display: block;
      font-size: 12px;
      color: #666;
      margin-top: 5px;
      margin-bottom: 10px;
    }
    .upload-area {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      margin-bottom: 10px;
    }
    .upload-button {
      width: 100%;
      max-width: 200px;
      background-color: #1890ff;
      color: white;
      transition: all 0.3s ease;
    }
    .upload-button:hover {
      background-color: #40a9ff;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(24, 144, 255, 0.2);
    }
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    label {
      margin-bottom: 5px;
    }
    input[type="text"], select {
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    input[type="range"] {
      width: 100%;
    }
  </style>
</body>
</html>